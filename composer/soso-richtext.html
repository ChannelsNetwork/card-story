<dom-module id="soso-richtext">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        min-height: 1em;
        font-family: inherit;
        font-size: inherit;
        line-height: inherit;
        font-weight: inherit;
        word-break: break-word;
        border: 1px solid #d8d8d8;
      }

      :host([contenteditable]) {
        outline: none;
      }

      :host::before {
        content: var(--richtext-placeholder);
        opacity: 0.5;
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
      }
    </style>
    <slot></slot>
  </template>

  <script>
    class SosoRichtext extends Polymer.Element {
      static get is() { return 'soso-richtext'; }
      static get properties() {
        return {
          placeholder: String,
          editing: {
            type: Boolean,
            observer: '_onEditing'
          },
          delegate: {
            type: Object,
            observer: '_attachToolbar'
          }
        }
      }

      constructor() {
        super();
        this.addEventListener('focus', (event) => {
          this.dispatchEvent(new CustomEvent('focused', { bubbles: true, composed: true, detail: {} }));
        });
        this.addEventListener('blur', (event) => {
          this.dispatchEvent(new CustomEvent('blurred', { bubbles: true, composed: true, detail: {} }));
        });
        this.addEventListener('input', () => {
          let tx = this.textContent.trim();
          let hasList = (this.value.indexOf("<ol>") >= 0) || (this.value.indexOf("<ul>") >= 0);
          if (tx || hasList) {
            this.updateStyles({ '--richtext-placeholder': "" });
          } else {
            this.updateStyles({ '--richtext-placeholder': "'" + (this.placeholder || "") + "'" });
          }
        });
      }

      connectedCallback() {
        super.connectedCallback();
        this._attached = true;
        this.updateStyles({ '--richtext-placeholder': "'" + (this.placeholder || "") + "'" });
        this._attachToolbar();
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this._attached = false;
        this._detachToolbar();
        this._detachListeners();
      }

      _attachToolbar() {
        if (this._attached && this.delegate && this.delegate.toolbar) {
          this._detachToolbar();
          this._toolbarActionListener = this._handleToolbarAction.bind(this);
          this.delegate.toolbar.addEventListener("action", this._toolbarActionListener);
        }
      }

      _detachToolbar() {
        if (this.delegate && this.delegate.toolbar && this._toolbarActionListener) {
          this.delegate.toolbar.removeEventListener("action", this._toolbarActionListener);
          this._toolbarActionListener = null;
        }
      }

      _onEditing() {
        if (this.editing) {
          this.contentEditable = true;
          this.focus();
          setTimeout(() => {
            this.focus();
            this._onSelection();
          }, 100);
          this._attachListeners();
        } else {
          this.contentEditable = false
          this._clearSelection();
          this._detachListeners();
        }
      }

      get value() {
        return this.innerHTML;
      }

      set value(v) {
        this.innerHTML = v;
      }

      get textValue() {
        return this.textContent;
      }

      _attachListeners() {
        this._detachListeners();

        this._selectionListener = () => {
          if (this._selectionTimer) {
            clearTimeout(this._selectionTimer);
            this._selectionTimer = null;
          }
          this._selectionTimer = setTimeout(() => {
            this._selectionTimer = null;
            if (this._attached && this.editing) {
              this._onSelection();
            }
          }, 250);
        };
        document.addEventListener("selectionchange", this._selectionListener);

        this._keyPressListener = this._handleKeyPress.bind(this);
        this.addEventListener("keypress", this._keyPressListener);

        this._keyDownListener = (event) => {
          if (event.keyCode === 13) {
            if (event.ctrlKey || event.shiftKey || event.altKey || event.metaKey) {
              return;
            }
            let hasList = (this.value.indexOf("<ol>") >= 0) || (this.value.indexOf("<ul>") >= 0);
            if (!hasList) {
              let text = this.textValue.trim();
              if (!text) {
                return;
              }
              event.preventDefault();
              this.dispatchEvent(new CustomEvent('enter-key', { bubbles: true, composed: true }));
            }
          } else if (event.keyCode === 8) {
            let text = this.textValue.trim();
            if (!text) {
              const selection = this.selection;
              const range = selection.getRangeAt(0);
              if (range.startOffset === 0) {
                setTimeout(() => {
                  this.dispatchEvent(new CustomEvent('empty-backspace', { bubbles: true, composed: true }));
                });
              }
            }
          }
        };
        this.addEventListener("keydown", this._keyDownListener);

        this._pasteListener = this._handlePaste.bind(this);
        this.addEventListener("paste", this._pasteListener);
      }

      _detachListeners() {
        if (this._selectionListener) {
          document.removeEventListener("selectionchange", this._selectionListener);
          this._selectionListener = null;
        }
        if (this._keyPressListener) {
          this.removeEventListener("keypress", this._keyPressListener);
          this._keyPressListener = null;
        }
        if (this._keyDownListener) {
          this.removeEventListener("keydown", this._keyDownListener);
          this._keyDownListener = null;
        }
        if (this._pasteListener) {
          this.removeEventListener("paste", this._pasteListener);
          this._pasteListener = null;
        }
        this._hideToolbar();
      }

      get selection() {
        if (this.parentNode.getSelection) {
          return this.parentNode.getSelection();
        }
        return document.getSelection();
      }

      _onSelection() {
        const selection = this.selection;
        if (selection.type === "Range") {
          let rect = selection.getRangeAt(0).getBoundingClientRect();
          this._showToolbar(rect);
        } else {
          this._hideToolbar();
        }
        if (this.delegate) {
          this.delegate.hideLink();
        }
      }

      _clearSelection() {
        const selection = this.selection;
        if (selection) {
          selection.removeAllRanges();
        }
      }

      _showToolbar(rect) {
        this._refreshBarState();
        this.delegate.showToolbar(rect);
      }

      _hideToolbar() {
        this.delegate.hideToolbar();
      }

      _handleToolbarAction(event) {
        switch (event.detail.type) {
          case "bold":
            document.execCommand("bold");
            break;
          case "italic":
            document.execCommand("italic");
            break;
          case "clear":
            document.execCommand("removeFormat");
            break;
          case "link":
            if (this._isSelectionLinked()) {
              document.execCommand("unlink");
            } else {
              this._hideToolbar();
              setTimeout(() => {
                this.delegate.createLink(this.selection.getRangeAt(0));
              }, 200);
            }
            break;
          default:
            break;
        }
        this._refreshBarState();
      }

      _refreshBarState() {
        this.delegate.toolbarState = {
          bold: document.queryCommandState("bold"),
          italic: document.queryCommandState("italic"),
          linked: this._isSelectionLinked()
        };
      }

      insertLink(url, range) {
        this.editing = true;
        setTimeout(() => {
          const selection = this.selection;
          selection.removeAllRanges();
          selection.addRange(range);
          document.execCommand("createLink", null, url);
          this._refreshBarState();
        }, 50);
      }

      _isSelectionLinked() {
        const selection = this.selection;
        if (selection && (selection.type === "Range")) {
          const range = selection.getRangeAt(0);
          if (range) {
            let container = range.commonAncestorContainer;
            if (container) {
              if (container.nodeType == 3) { container = container.parentNode; }
              if (container.nodeName === "A") {
                return true;
              }
            }
          }
        }
        return false;
      }

      _handleKeyPress(event) {
        if (event.keyCode === 41 || event.keyCode === 46) {
          let text = this.textContent.trim();
          if (text === "1") {
            event.preventDefault();
            event.stopPropagation();
            setTimeout(() => {
              this.innerHTML = "";
              document.execCommand("insertOrderedList");
            });
          }
        } else if (event.keyCode === 32) {
          let text = this.textContent.trim();
          if (text === "*") {
            event.preventDefault();
            event.stopPropagation();
            setTimeout(() => {
              this.innerHTML = "";
              document.execCommand("insertUnorderedList");
            });
          }
        }
      }

      _handlePaste(event) {
        event.preventDefault();
        let clipboard = event.clipboardData || window.clipboardData;
        if (clipboard) {
          let html = clipboard.getData("text/html");
          if (html) {
            let currentRange = this.selection.getRangeAt(0);
            if (currentRange) {
              currentRange = currentRange.cloneRange();
            }

            let div = document.createElement("div");
            div.contentEditable = true;
            div.style.width = "1px";
            div.style.height = "1px";
            div.style.position = "fixed";
            div.style.left = "-100px";
            div.style.top = "-100px";
            div.style.overflow = "hidden";
            div.style.opacity = 0;
            div.innerHTML = html;
            document.body.appendChild(div);
            div.focus();
            setTimeout(() => {
              div.focus();
              setTimeout(() => {
                this._cleanHtml(div);
                this._insertHtml(div.innerHTML, currentRange).then(() => {
                  div.parentNode.removeChild(div);
                });
              });
            }, 50);
          } else {
            let text = clipboard.getData("text/plain") || clipboardData.getData('Text');
            if (text) {
              setTimeout(() => {
                document.execCommand("insertText", null, text)
              });
            }
          }
        }
      }

      _insertHtml(html, range) {
        return new Promise((resolve, reject) => {
          this.editing = true;
          this.focus();
          // this.dispatchEvent(new CustomEvent('focused', { bubbles: true, composed: true, detail: {} }));
          setTimeout(() => {
            this.focus();
            setTimeout(() => {
              if (range) {
                const selection = this.selection;
                selection.removeAllRanges();
                selection.addRange(range);
              }
              document.execCommand("insertHTML", null, html);
              resolve();
            }, 50);
          }, 50);
        });
      }

      _cleanHtml(div) {
        for (var i = 0; i < 5; i++) {
          document.execCommand("selectAll");
          document.execCommand("removeFormat");
        }
        const ignoreList = ["figure", "img", "image", "form", "input", "select", "video", "audio", "meta", "script", "link", "meta", "applet", "aside",
          "object", "entity", "button", "canvas", "svg", "font", "frame", "iframe"];
        ignoreList.forEach((tag) => {
          let nl = div.getElementsByTagName(tag);
          let list = [];
          for (let i = 0; i < nl.length; i++) {
            list.push(nl[i]);
          }
          list.forEach((d) => {
            if (d.parentNode)
              d.parentNode.removeChild(d);
          });
        });
      }

      selectEnd() {
        let range = document.createRange();
        range.selectNodeContents(this);
        range.collapse(false);
        const selection = this.selection;
        selection.removeAllRanges();
        selection.addRange(range);
      }
    }

    window.customElements.define(SosoRichtext.is, SosoRichtext);
  </script>
</dom-module>