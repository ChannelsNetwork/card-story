<dom-module id="soso-richtext">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        min-height: 1em;
        font-family: inherit;
        font-size: inherit;
        line-height: inherit;
        font-weight: inherit;
        word-break: break-word;
        border: 1px solid #d8d8d8;
      }

      :host([contenteditable]) {
        outline: none;
      }

      :host::before {
        content: var(--richtext-placeholder);
        opacity: 0.5;
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
      }
    </style>
    <slot></slot>
  </template>

  <script>
    class SosoRichtext extends Polymer.Element {
      static get is() { return 'soso-richtext'; }
      static get properties() {
        return {
          placeholder: String,
          editing: {
            type: Boolean,
            observer: '_onEditing'
          }
        }
      }

      constructor() {
        super();
        this._editing = false;
        this.addEventListener('focus', (event) => {
          event.stopPropagation();
          this._attachSelectionListener();
          this.dispatchEvent(new CustomEvent('focused', { bubbles: true, composed: true, detail: {} }));
        });
        this.addEventListener('blur', (event) => {
          event.stopPropagation();
          this._detachSelectionListener();
          this.dispatchEvent(new CustomEvent('blurred', { bubbles: true, composed: true, detail: {} }));
        });
        this.addEventListener('input', () => {
          let tx = this.textContent.trim();
          if (tx) {
            this.updateStyles({ '--richtext-placeholder': "" });
          } else {
            this.updateStyles({ '--richtext-placeholder': "'" + (this.placeholder || "") + "'" });
          }
        });
      }

      connectedCallback() {
        super.connectedCallback();
        this.updateStyles({ '--richtext-placeholder': "'" + (this.placeholder || "") + "'" });
      }

      _onEditing() {
        if (this.editing) {
          this.contentEditable = true;
          this.focus();
          setTimeout(() => {
            this.focus();
          }, 100);
        } else {
          this.contentEditable = false
        }
      }

      get value() {
        return this.innerHTML;
      }

      set value(v) {
        this.innerHTML = v;
      }

      _attachSelectionListener() {
        this._detachSelectionListener();
        this._selectionListener = () => {
          this._onSelection();
        };
        document.addEventListener("selectionchange", this._selectionListener);
      }

      _detachSelectionListener() {
        if (this._selectionListener) {
          document.removeEventListener("selectionchange", this._selectionListener);
          this._selectionListener = null;
        }
        this._hideToolbar();
      }

      _onSelection() {
        const selection = this.parentNode.getSelection();
        if (selection.type === "Range") {
          this._showToolbar();
        } else {
          this._hideToolbar();
        }
      }

      _showToolbar() {
        if (!this._toolbarVisible) {
          console.log("show bar");
          this._toolbarVisible = true;
        }
      }

      _hideToolbar() {
        if (this._toolbarVisible) {
          console.log("hide bar");
          this._toolbarVisible = false;
        }
      }
    }

    window.customElements.define(SosoRichtext.is, SosoRichtext);
  </script>
</dom-module>