<dom-module id="soso-richtext">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        min-height: 1em;
        font-family: inherit;
        font-size: inherit;
        line-height: inherit;
        font-weight: inherit;
        word-break: break-word;
        border: 1px solid #d8d8d8;
      }

      :host([contenteditable]) {
        outline: none;
      }

      :host::before {
        content: var(--richtext-placeholder);
        opacity: 0.5;
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
      }
    </style>
    <slot></slot>
  </template>

  <script>
    class SosoRichtext extends Polymer.Element {
      static get is() { return 'soso-richtext'; }
      static get properties() {
        return {
          placeholder: String,
          editing: {
            type: Boolean,
            observer: '_onEditing'
          },
          toolbar: {
            type: Object,
            observer: '_attachToolbar'
          },
          delegate: Object
        }
      }

      constructor() {
        super();
        this.addEventListener('focus', (event) => {
          event.stopPropagation();
          this.dispatchEvent(new CustomEvent('focused', { bubbles: true, composed: true, detail: {} }));
        });
        this.addEventListener('blur', (event) => {
          event.stopPropagation();
          this.dispatchEvent(new CustomEvent('blurred', { bubbles: true, composed: true, detail: {} }));
        });
        this.addEventListener('input', () => {
          let tx = this.textContent.trim();
          if (tx) {
            this.updateStyles({ '--richtext-placeholder': "" });
          } else {
            this.updateStyles({ '--richtext-placeholder': "'" + (this.placeholder || "") + "'" });
          }
        });
      }

      connectedCallback() {
        super.connectedCallback();
        this._attached = true;
        this.updateStyles({ '--richtext-placeholder': "'" + (this.placeholder || "") + "'" });
        this._attachToolbar();
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this._attached = false;
        this._detachToolbar();
      }

      _attachToolbar() {
        if (this._attached && this.toolbar) {
          this._detachToolbar();
          this._toolbarActionListener = this._handleToolbarAction.bind(this);
          this.toolbar.addEventListener("action", this._toolbarActionListener);
        }
      }

      _detachToolbar() {
        if (this.toolbar && this._toolbarActionListener) {
          this.toolbar.removeEventListener("action", this._toolbarActionListener);
          this._toolbarActionListener = null;
        }
      }

      _onEditing() {
        if (this.editing) {
          this.contentEditable = true;
          this.focus();
          setTimeout(() => {
            this.focus();
            this._onSelection();
          }, 100);
          this._attachSelectionListener();
        } else {
          this.contentEditable = false
          this._clearSelection();
          this._detachSelectionListener();
        }
      }

      get value() {
        return this.innerHTML;
      }

      set value(v) {
        this.innerHTML = v;
      }

      _attachSelectionListener() {
        this._detachSelectionListener();

        this._selectionListener = () => {
          if (this._selectionTimer) {
            clearTimeout(this._selectionTimer);
            this._selectionTimer = null;
          }
          this._selectionTimer = setTimeout(() => {
            this._selectionTimer = null;
            if (this._attached && this.editing) {
              this._onSelection();
            }
          }, 250);
        };
        document.addEventListener("selectionchange", this._selectionListener);
      }

      _detachSelectionListener() {
        if (this._selectionListener) {
          document.removeEventListener("selectionchange", this._selectionListener);
          this._selectionListener = null;
        }
        this._hideToolbar();
      }

      _onSelection() {
        const selection = this.parentNode.getSelection();
        if (selection.type === "Range") {
          let rect = selection.getRangeAt(0).getBoundingClientRect();
          this._showToolbar(rect);
        } else {
          this._hideToolbar();
        }
        if (this.delegate) {
          this.delegate.hideLink();
        }
      }

      _clearSelection() {
        const selection = this.parentNode.getSelection();
        if (selection) {
          selection.removeAllRanges();
        }
      }

      _showToolbar(rect) {
        if (!this.toolbar) {
          return;
        }
        if (!this._toolbarVisible) {
          this._toolbarVisible = true;
          this.toolbar.style.display = "";
        }
        this._refreshBarState();
        this._updateToolbarPosition(rect);
      }

      _updateToolbarPosition(rect) {
        if (rect) {
          let myRect = this.getBoundingClientRect();
          this.toolbar.style.left = Math.max(62, rect.x - myRect.x + (rect.width / 2)) + "px";
          this.toolbar.style.top = Math.max(0, rect.y - myRect.y) + "px";
        }
      }

      _hideToolbar() {
        if (this._toolbarVisible) {
          this._toolbarVisible = false;
          this.toolbar.style.display = "none";
        }
      }

      _handleToolbarAction(event) {
        switch (event.detail.type) {
          case "bold":
            document.execCommand("bold");
            break;
          case "italic":
            document.execCommand("italic");
            break;
          case "link":
            if (this._isSelectionLinked()) {
              document.execCommand("unlink");
            } else {
              this._hideToolbar();
              setTimeout(() => {
                this.delegate.createLink(this.parentNode.getSelection().getRangeAt(0));
              }, 200);
            }
            break;
          default:
            break;
        }
        this._refreshBarState();
      }

      _refreshBarState() {
        if (this.toolbar) {
          this.toolbar.state = {
            bold: document.queryCommandState("bold"),
            italic: document.queryCommandState("italic"),
            linked: this._isSelectionLinked()
          };
        }
      }

      insertLink(url, range) {
        this.editing = true;
        setTimeout(() => {
          const selection = this.parentNode.getSelection();
          selection.removeAllRanges();
          selection.addRange(range);
          document.execCommand("createLink", null, url);
          this._refreshBarState();
        }, 50);
      }

      _isSelectionLinked() {
        const selection = this.parentNode.getSelection();
        if (selection) {
          const range = selection.getRangeAt(0);
          if (range) {
            let container = range.commonAncestorContainer;
            if (container) {
              if (container.nodeType == 3) { container = container.parentNode; }
              if (container.nodeName === "A") {
                return true;
              }
            }
          }
        }
        return false;
      }
    }

    window.customElements.define(SosoRichtext.is, SosoRichtext);
  </script>
</dom-module>